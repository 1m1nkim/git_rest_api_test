<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Commit Detail</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
        }
        .container {
            display: flex;
            width: 100%;
        }
        .file-list {
            width: 25%;
            border-right: 1px solid #444;
            padding: 10px;
            overflow-y: auto;
            height: 80vh;
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
        .file-list ul {
            list-style-type: none;
            padding: 0;
        }
        .file-list li {
            padding: 8px;
            margin-bottom: 5px;
            background-color: #2d2d2d;
            cursor: pointer;
            border-radius: 3px;
        }
        .file-list li.selected {
            background-color: #264f78;
        }
        .diff-container {
            display: flex;
            width: 75%;
            background-color: #1e1e1e;
            color: #e0e0e0;
        }
        .diff-before, .diff-after {
            width: 50%;
            padding: 0;
            overflow-y: auto;
            height: 80vh;
            position: relative;
        }
        .diff-before {
            border-right: 1px solid #444;
        }
        .code-container {
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            tab-size: 4;
        }
        .code-line {
            display: flex;
            width: 100%;
        }
        .line-number {
            width: 40px;
            text-align: right;
            padding-right: 10px;
            color: #858585;
            user-select: none;
            background-color: #252525;
            padding: 0 10px;
        }
        .line-content {
            padding: 0 10px;
            flex-grow: 1;
            white-space: pre;
            overflow-x: auto;
        }
        .added {
            background-color: rgba(46, 160, 67, 0.15);
            border-left: 3px solid #2ea043;
        }
        .removed {
            background-color: rgba(248, 81, 73, 0.15);
            border-left: 3px solid #f85149;
        }
        .commit-info {
            padding: 15px;
            background-color: #1e1e1e;
            color: #e0e0e0;
            margin-bottom: 10px;
            border-bottom: 1px solid #444;
        }
        h1, h2 {
            color: #e0e0e0;
        }
        a {
            color: #58a6ff;
            text-decoration: none;
        }
        a:hover {
            text-decoration: underline;
        }
        pre {
            margin: 0;
        }
    </style>
</head>
<body>
<div class="commit-info">
    <h1>Commit Detail</h1>
    <p><strong>Repository:</strong> <span th:text="${owner + '/' + repo}"></span></p>
    <p><strong>Commit:</strong> <span th:text="${commit.getSHA1()}"></span></p>
    <p><strong>Author:</strong> <span th:text="${commit.getCommitter().getName()}"></span></p>
    <p><strong>Date:</strong> <span th:text="${#dates.format(commit.getCommitDate(), 'yyyy-MM-dd HH:mm')}"></span></p>
    <p><strong>Message:</strong> <span th:text="${commit.getCommitShortInfo().getMessage()}"></span></p>
</div>

<div class="container">
    <div class="file-list">
        <h2>변경된 파일 목록</h2>
        <ul>
            <li th:each="file : ${changedFiles}"
                th:text="${file.getFileName()}"
                th:data-path="${file.getFileName()}"
                th:data-status="${file.getStatus()}"
                onclick="loadFileDiff(this.getAttribute('data-path'))"
                th:class="${fileStat.first ? 'selected' : ''}">
            </li>
        </ul>
    </div>

    <div class="diff-container">
        <div class="diff-before" id="diff-before">
            <h2>변경 전</h2>
            <div id="before-content">
                <!-- 선택된 파일의 변경 전 내용이 여기에 표시됩니다 -->
                <p>파일을 선택하면 변경 전 내용이 표시됩니다.</p>
            </div>
        </div>

        <div class="diff-after" id="diff-after">
            <h2>변경 후</h2>
            <div id="after-content">
                <!-- 선택된 파일의 변경 후 내용이 여기에 표시됩니다 -->
                <p>파일을 선택하면 변경 후 내용이 표시됩니다.</p>
            </div>
        </div>
    </div>
</div>

<p th:if="${error != null}" th:text="${error}"></p>

<p><a th:href="@{'/repos/' + ${owner} + '/' + ${repo} + '/commits'}">Back to Commits</a></p>

<script th:inline="javascript">
    const owner = /*[[${owner}]]*/ 'default-owner';
    const repo = /*[[${repo}]]*/ 'default-repo';
    const commitSha = /*[[${commit.getSHA1()}]]*/ 'default-sha';

    function loadFileDiff(filePath) {
        // 선택된 파일 하이라이트
        document.querySelectorAll('.file-list li').forEach(li => {
            li.classList.remove('selected');
            if (li.getAttribute('data-path') === filePath) {
                li.classList.add('selected');
            }
        });

        // AJAX 요청으로 파일 diff 가져오기
        fetch(`/api/repos/${owner}/${repo}/commit/${commitSha}/file?filePath=${encodeURIComponent(filePath)}`)
            .then(response => response.json())
            .then(data => {
                renderDiffContent('before-content', data.before, false);
                renderDiffContent('after-content', data.after, true);
            })
            .catch(error => {
                console.error('Error loading file diff:', error);
                document.getElementById('before-content').innerHTML =
                    '<p>파일 변경 내역을 불러오는 중 오류가 발생했습니다.</p>';
                document.getElementById('after-content').innerHTML =
                    '<p>파일 변경 내역을 불러오는 중 오류가 발생했습니다.</p>';
            });
    }

    function renderDiffContent(elementId, content, isAfter) {
        const container = document.getElementById(elementId);
        container.innerHTML = '';
        container.className = 'code-container';

        if (!content) {
            container.innerHTML = '<p>내용이 없습니다.</p>';
            return;
        }

        const lines = content.split('\n');

        lines.forEach((line, index) => {
            const lineDiv = document.createElement('div');
            lineDiv.className = 'code-line';

            const lineNumber = document.createElement('div');
            lineNumber.className = 'line-number';
            lineNumber.textContent = index + 1;

            const lineContent = document.createElement('div');
            lineContent.className = 'line-content';

            let displayText = line;

            // 변경된 내용 하이라이트
            if (isAfter) {
                // 변경 후 파일에서는 모든 코드를 초록색으로 표시
                lineContent.classList.add('added');
                displayText = line.startsWith('+') ? line.substring(1) : line;
            } else if (!isAfter && line.startsWith('-')) {
                // 변경 전 파일에서는 삭제된 코드만 빨간색으로 표시
                lineContent.classList.add('removed');
                displayText = line.substring(1);
            }

            // 텍스트 내용 설정 (공백 보존)
            lineContent.textContent = displayText;

            lineDiv.appendChild(lineNumber);
            lineDiv.appendChild(lineContent);
            container.appendChild(lineDiv);
        });
    }

    // 페이지 로드 시 첫 번째 파일의 diff 로드
    document.addEventListener('DOMContentLoaded', function() {
        const files = document.querySelectorAll('.file-list li');
        if (files.length > 0) {
            loadFileDiff(files[0].getAttribute('data-path'));
        }
    });
</script>
</body>
</html>
